{% extends 'base_app.html' %}
{% load humanize %}
{% block 'body' %}
<div>
    <p class="heading-1">Exported Company Tools</p>
</div>
<div class="card p-4">
    <p class="heading-2">
        Import a Company
    </p>
    <a href="{% url 'app-company-import' %}">Import a Company</a>
</div>
<div class="card p-4 mt-4">
    <p class="heading-2">
        Compare Company Data
    </p>
    <div class="mt-4">
        <div class="form-check">
            <input type="checkbox" class="form-check-input" id="check-order-check" onclick="return false;" checked>
            <label class="form-check-label" for="check-order-check"><em>Entry Order: Always checked</em></label>
        </div>
        <div class="form-check">
            <input type="checkbox" class="form-check-input" id="check-order-check" onclick="return false;" checked>
            <label class="form-check-label" for="check-order-check"><em>Entry Accounts & Ammounts: Always checked</em></label>
        </div>
        <div class="form-check">
            <input type="checkbox" class="form-check-input" id="check-date-check">
            <label class="form-check-label" for="check-date-check">Entry Date</label>
        </div>
        <div class="form-check">
            <input type="checkbox" class="form-check-input" id="check-memo-check">
            <label class="form-check-label" for="check-memo-check">Entry Memo</label>
        </div>
    </div>

    <div class="row">
        <div class="col-12 col-lg-6 mt-4">
            <div class="mb-3">
                <p style="font-size:1.1rem;">Test</p>
            </div>
            <div class="mb-3">
                Highlight test company with:
                    <div 
                        style="display:inline-block;width:35px;height:15px;background-color:#d37878;border-radius:4px; "
                        id="color-left-indicator"
                    ></div>
            </div>
            <textarea style="width:100%; min-height:200px" placeholder="Paste Company Data Here"></textarea>
        </div>
        <div class="col-12 col-lg-6 mt-4">
            <div class="mb-3">
                <p style="font-size:1.1rem;">Control</p>
            </div>
            <div class="mb-3">
                Highlight control company with:
                <div
                    id="color-right-indicator"
                    style="display:inline-block;width:35px;height:15px;background-color:#00ff00;border-radius:4px;"
                ></div>
            </div>
            <textarea style="width:100%;  min-height:200px" placeholder="Paste Company Data Here"></textarea>
        </div>

    </div>
    <button class="btn btn-success mt-3">
        <strong>Compare</strong>
    </button>
</div>
<script>
    $(document).ready(()=>{

    })
</script>
<div class="card p-4 mt-4">
    <p class="heading-2">
        View Export User History
    </p>

    <div id="output-area">
    </div>

    <div class="alert alert-danger mt-4" id="view-export-history-errors" style="display:none;">
    </div>
    <div class="mt-4">
        <input type="file" accept=".txt" id="import-company-file-picker">
    </div>
    <div class="mt-3">
        <strong>or</strong>
    </div>
    <textarea 
        class="mt-3"
        style="width:100%; 
        min-height:200px"
        id="see-history-text-input"
        placeholder="Paste Company Data Here"
    ></textarea>

    <button class="btn btn-success mt-3" id="see-company-export-history-btn">
        <strong>View</strong>
    </button>
</div>
<script>
function resetExportHistoryErrorArea() {
    $("#view-export-history-errors").text("")
    $("#view-export-history-errors").css("display", "none")
}
function drawExportHistoryErrors(errors) {
    $("#view-export-history-errors").css("display", "block")
    $("#view-export-history-errors").text(errors)
}
function disableSeeHistoryBtn() {
    $("#see-company-export-history-btn").prop("disabled", true)
}
function enableSeeHistoryBtn() {
    $("#see-company-export-history-btn").prop("disabled", false)
}
function drawResults(results) {
    $("#output-area").html("")
    $("#output-area").append(`
        <p class="pb-1"><strong>Results:</strong></p>
        <div class="row border-bottom mb-2">
            <div class="col-6 col-lg-3">
                <strong>Timestamp</strong>
            </div>
            <div class="col-3 col-lg-2">
                <strong>User ID</strong>
            </div>
            <div class="col-3 col-lg-2">
                <strong>Event</strong>
            </div>
        </div>
    `)
    for (let i=0; i<results.length; i++) {
        $("#output-area").append(`
            <div class="row mt-1 report-row">
                <div class="col-6 col-lg-3">
                    ${moment((results[i].timestamp - 0) * 1000).format('lll')}
                </div>
                <div class="col-3 col-lg-2">
                    ${results[i].user_hash}
                </div>
                <div class="col-3 col-lg-2">
                    ${results[i].event}
                </div>
            </div>
        `)
    }
}
$(document).ready(()=>{
    $("#see-company-export-history-btn").click(()=>{
        disableSeeHistoryBtn()
        resetExportHistoryErrorArea()

        const selectedFile = $("#import-company-file-picker")[0].files[0]
        if (selectedFile) {
            // Upload with file picker
            if (selectedFile.type != "text/plain") {
                enableSeeHistoryBtn()
                return addErrorToForm("Invalid file type selected")
            }
            const formData = new FormData(); 
            formData.append('company_text_file', selectedFile);
            postFormData(companyExportHistoryUrl, formData,
                (data, status, xhr)=>{ 
                    if(xhr.status == 200) {
                        enableSeeHistoryBtn()
                        drawResults(data)
                        $("#import-company-file-picker").val("")
                    }
                },
                (data, status, xhr)=>{
                    enableSeeHistoryBtn()
                    addErrorToForm("An Error Occured.")
                })
        }
        else {
            const serializedData = $("#see-history-text-input").val().replace(/\s+/g, '')
            if(!!!serializedData) {
                enableSeeHistoryBtn()
                return drawExportHistoryErrors("Either select a file or paste company data into the text box.")
            }
            if(!/^\S+\:\S{15,}$/.test(serializedData)) {
                enableSeeHistoryBtn()
                return drawExportHistoryErrors("Invalid Format")
            }
            postJson(companyExportHistoryUrl, {company_text_data:serializedData},
                (data, status, xhr)=>{
                    if(xhr.status == 200) {
                        drawResults(data)
                        $("#see-history-text-input").val("")
                        enableSeeHistoryBtn()
                    }
                },
                (data, status, xhr)=>{
                    enableSeeHistoryBtn()
                    return drawExportHistoryErrors("An Error Occured")
                }
            )
        }
    })
})
</script>
{% endblock %}
