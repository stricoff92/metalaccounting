{% extends 'base_app.html' %} 
{% block 'body' %}
<div>
    <p class="heading-1">Accounts List</p>
    <p class="heading-2">{{ company.name }}</p>
</div>

<div id="new-account-form-container" class="mt-3">
    <button class="btn btn-primary" id="open-new-account-form-btn">
        <i class="fas fa-plus-square"></i>
        New Account
    </button>
    <div id="new-company-form" style="display:none" class="card mt-4 mb-3 p-3">
        <p class="heading-2">Create a New Account</p>
        <div
            id="new-company-form-errors"
            class="mt-2 mb-2 p-2 alert alert-danger"
            style="display:none"
        >
        </div>
        <div class="mt-3">
            <button class="btn btn-success" id="save-new-account-btn">
                <i class="fas fa-save"></i> Save
            </button>
        </div>
    </div>
</div>

<div id="accounts-list" class="mt-3 mb-3">
    <div class="alert alert-info" id="no-accounts-yet-msg" style="display:none;">
        You don't have any accounts for this company yet.
        <div class="mt-3">
            <button 
                class="btn btn-primary"
                onclick="window.location='/app/company/{{ company.slug }}/default-account/'"
            >
                <i class="fas fa-bolt"></i>
                Add Default Accounts
            </button>
        </div>
        <div class="mt-3">
            <button class="btn btn-primary">
                <i class="fas fa-bolt"></i>
                Import Accounts
            </button>
        </div>
    </div>


</div>
<script>
function addAccountToList(accountData) {
    const accountRowDiv = document.createElement("div");
    $(accountRowDiv).attr("id", `account-row-${accountData.slug}`)
    $(accountRowDiv).addClass(['card', 'p-2', 'mt-1'])

    const accountRowInnerDivTop = document.createElement("div");
    $(accountRowInnerDivTop).css(
        {'display':'flex', 'justify-content': 'space-between'})
    $(accountRowInnerDivTop).html(`
        <div>
            <strong>
                <span id="account-name-span-${accountData.slug}"></span>
            </strong>
            (${accountData.number})
        </div>
        <div style="display:flex; flex-wrap:nowrap;">
            <button class="btn btn-success" onclick="window.location='/app/account/${accountData.slug}/'">
                <i class="fas fa-hand-point-right"></i>
                Open
            </button>
            <button
                class="btn btn-danger"
                id="delete-account-${accountData.slug}-btn"
                ${accountData.has_entries ? 'disabled' : ''}
            >
                <i class="fas fa-trash-alt"></i>
                Delete
            </button>
        </div>
    `)
    $(accountRowDiv).append(accountRowInnerDivTop)

    const accountRowInnerDivBottom = document.createElement("div");
    $(accountRowInnerDivBottom).append(`<span>${accountData.type}</span>`)
    if(accountData.is_contra){
        $(accountRowInnerDivBottom).append(`
            <span class="badge badge-pill badge-info">
                contra
            </span>
        `)
    }
    $(accountRowDiv).append(accountRowInnerDivBottom)
    $("#accounts-list").append(accountRowDiv)
    $(`#account-name-span-${accountData.slug}`).text(accountData.name)

    if(!accountData.has_entries) {
        $(`#delete-account-${accountData.slug}-btn`).click(()=>{
            const url = accountDeleteUrl(accountData.slug)
            const data = {}
            postJson(url, data, 
                (data, status, xhr)=>{
                    if(xhr.status == 204) {
                        return $(`#account-row-${accountData.slug}`).remove()
                    }
                    alert("An Error Occured: " + status)
                },
                (data, status, xhr)=>{
                    alert("An Error Occured: " + status)
                    console.error(data)
                })
        })
    }
}
$(document).ready(()=>{
    const url = "{% url 'account-list' %}?company={{ company.slug }}"
    $.get(url, (accounts, status, xhr)=>{
        if (xhr.status != 200) {
            return alert("An Error Occured. " + status)
        }
        if (accounts.length == 0) {
            $("#no-accounts-yet-msg").css("display", "block")
            return
        }
        accounts.forEach(addAccountToList)
    })
})
</script>
{% endblock %}
